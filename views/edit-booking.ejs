<%- include('partials/navbar') %>

<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Edit Booking</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/flatpickr/dist/themes/material_blue.css" rel="stylesheet">
  <link rel="stylesheet" href="/styles/main.css">
</head>
<body>
<div class="container mt-4">
  <h1>Edit Booking</h1>

  <form action="/edit-booking/<%= booking.id %>" method="POST" enctype="multipart/form-data">
    <!-- Requester -->
    <div class="mb-3">
      <label for="requester" class="form-label">Requester Name:</label>
      <input type="text" class="form-control" id="requester" name="requester" value="<%= booking.requester %>" required>
    </div>

    <!-- Email -->
    <div class="mb-3">
      <label for="email" class="form-label">Email:</label>
      <input type="email" class="form-control" id="email" name="email" value="<%= booking.email %>" required>
    </div>

    <!-- Type of Use -->
    <div class="mb-3">
      <label for="type_of_use" class="form-label">Type of Use:</label>
      <select class="form-select" id="type_of_use" name="type_of_use" required>
        <option value="">-- Select --</option>
        <option value="Training" <%= booking.type_of_use==='Training'?'selected':'' %>>Training</option>
        <option value="Competition" <%= booking.type_of_use==='Competition'?'selected':'' %>>Competition</option>
        <option value="Event" <%= booking.type_of_use==='Event'?'selected':'' %>>Event</option>
        <option value="Other" <%= (booking.type_of_use!=='Training' && booking.type_of_use!=='Competition' && booking.type_of_use!=='Event')?'selected':'' %>>Other</option>
      </select>
      <input type="text" class="form-control mt-2" id="type_of_use_other" name="type_of_use_other" placeholder="Please specify if Other" value="<%= (booking.type_of_use!=='Training' && booking.type_of_use!=='Competition' && booking.type_of_use!=='Event')?booking.type_of_use:'' %>">
    </div>

    <!-- Participants -->
    <div class="mb-3">
      <label for="participants" class="form-label">Participants:</label>
      <input type="number" class="form-control" id="participants" name="participants" value="<%= booking.participants %>">
    </div>

    <!-- Supervisors -->
    <div class="mb-3">
      <label for="supervisors" class="form-label">Supervisors:</label>
      <input type="number" class="form-control" id="supervisors" name="supervisors" value="<%= booking.supervisors %>">
    </div>

    <!-- Date -->
    <div class="mb-3">
      <label for="date" class="form-label">Date:</label>
      <input type="text" class="form-control" id="date" name="date" value="<%= booking.date.toISOString().slice(0,10) %>" required>
    </div>

    <!-- Start Time -->
    <div class="mb-3">
      <label for="start_time" class="form-label">Start Time:</label>
      <input type="text" class="form-control" id="start_time" name="start_time" value="<%= booking.start_time %>" required>
    </div>

    <!-- Finish Time -->
    <div class="mb-3">
      <label for="finish_time" class="form-label">Finish Time:</label>
      <input type="text" class="form-control" id="finish_time" name="finish_time" value="<%= booking.finish_time %>" required>
    </div>

    <!-- Equipment -->
    <div class="mb-3">
      <label class="form-label">Equipment:</label>
      <div class="row">
        <div class="col-md-4">
          <div class="form-check">
            <input class="form-check-input" type="checkbox" name="equipment[]" value="Microphone" id="eq1" <%= booking.equipment?.includes('Microphone')?'checked':'' %>>
            <label class="form-check-label" for="eq1">Microphone</label>
          </div>
          <div class="form-check">
            <input class="form-check-input" type="checkbox" name="equipment[]" value="Touchpads and Electronic timing system" id="eq2" <%= booking.equipment?.includes('Touchpads and Electronic timing system')?'checked':'' %>>
            <label class="form-check-label" for="eq2">Touchpads & Timing</label>
          </div>
          <div class="form-check">
            <input class="form-check-input" type="checkbox" name="equipment[]" value="Meet Manager" id="eq3" <%= booking.equipment?.includes('Meet Manager')?'checked':'' %>>
            <label class="form-check-label" for="eq3">Meet Manager</label>
          </div>
        </div>
        <div class="col-md-4">
          <div class="form-check">
            <input class="form-check-input" type="checkbox" name="equipment[]" value="Water Polo goals" id="eq4" <%= booking.equipment?.includes('Water Polo goals')?'checked':'' %>>
            <label class="form-check-label" for="eq4">Water Polo goals</label>
          </div>
          <div class="form-check">
            <input class="form-check-input" type="checkbox" name="equipment[]" value="Water Polo Scoreboard" id="eq5" <%= booking.equipment?.includes('Water Polo Scoreboard')?'checked':'' %>>
            <label class="form-check-label" for="eq5">Water Polo Scoreboard</label>
          </div>
          <div class="form-check">
            <input class="form-check-input" type="checkbox" name="equipment[]" value="Diving Boards" id="eq6" <%= booking.equipment?.includes('Diving Boards')?'checked':'' %>>
            <label class="form-check-label" for="eq6">Diving Boards</label>
          </div>
        </div>
        <div class="col-md-4">
          <div class="form-check">
            <input class="form-check-input" type="checkbox" id="eqOtherCheck" <%= booking.equipment_other?'checked':'' %>>
            <label class="form-check-label" for="eqOtherCheck">Other</label>
          </div>
          <input type="text" class="form-control mt-1" id="equipment_other" name="equipment_other" placeholder="Specify other equipment" value="<%= booking.equipment_other %>" <%= booking.equipment_other?'':'disabled' %>>
        </div>
      </div>
    </div>

    <script>
      const eqOtherCheck = document.getElementById("eqOtherCheck");
      const equipmentOther = document.getElementById("equipment_other");

      eqOtherCheck.addEventListener("change", () => {
        equipmentOther.disabled = !eqOtherCheck.checked;
      });
    </script>

    <!-- Risk File -->
    <div class="mb-3">
      <label for="risk_file" class="form-label">Risk File (PDF) - optional:</label>
      <input type="file" class="form-control" id="risk_file" name="risk_file" accept=".pdf">
      <% if(booking.risk_file){ %>
        <small>Current file: <%= booking.risk_file %></small>
      <% } %>
    </div>

    <!-- Notes -->
    <div class="mb-3">
      <label for="notes" class="form-label">Notes:</label>
      <textarea class="form-control" id="notes" name="notes"><%= booking.notes || '' %></textarea>
    </div>

    <!-- Status -->
    <div class="mb-3">
      <label for="status" class="form-label">Status:</label>
      <select class="form-select" id="status" name="status" required>
        <option value="pending" <%= booking.status==='pending'?'selected':'' %>>Pending</option>
        <option value="approved" <%= booking.status==='approved'?'selected':'' %>>Approved</option>
        <option value="rejected" <%= booking.status==='rejected'?'selected':'' %>>Rejected</option>
      </select>
    </div>

    <!-- Feedback -->
    <div class="mb-3">
      <label for="feedback" class="form-label">Admin Feedback:</label>
      <textarea class="form-control" id="feedback" name="feedback"><%= booking.feedback || '' %></textarea>
    </div>

    <!-- Approved At -->
    <div class="mb-3">
      <label for="approved_at" class="form-label">Approved At:</label>
      <input type="datetime-local" class="form-control" id="approved_at" name="approved_at" value="<%= booking.approved_at ? new Date(booking.approved_at).toISOString().slice(0,16) : '' %>">
    </div>

    <button type="submit" class="btn btn-primary">Save & Resubmit (Pending)</button>
  </form>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
<script>
  flatpickr("#date", { dateFormat: "Y-m-d", minDate: "today" });
  flatpickr("#start_time", { enableTime: true, noCalendar: true, dateFormat: "H:i", time_24hr: false, minuteIncrement: 15 });
  flatpickr("#finish_time", { enableTime: true, noCalendar: true, dateFormat: "H:i", time_24hr: false, minuteIncrement: 15 });
</script>
</body>
</html>
